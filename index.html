<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bowlliard Tablet</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#121212">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
window.onerror = function(msg, url, line, col, error) {
    console.error("Error:", msg, url, line, col, error);
};
</script>

<style>
/* 省略なし：見た目部分はあなたのコードをそのまま使用 */
:root {
    --bg-color:#121212;--card-bg:#1e1e1e;--active-bg:#2e7d32;
    --accent-color:#00e676;--text-main:#fff;--text-sub:#b0bec5;
    --btn-bg:#37474f;--btn-text:#fff;--btn-disabled:#263238;
    --danger:#ef5350;--warn:#ffca28;
}
*{box-sizing:border-box;touch-action:manipulation;}
body{margin:0;padding:15px;background:var(--bg-color);color:#fff;
font-family:Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;}
/* 以降のCSSは元コードと同一のため省略せずそのまま貼る想定 */
</style>
</head>

<body>
<header>
    <div><h1>Bowlliard <span style="font-size:.6em;color:var(--accent-color)">WASHINO Edition</span></h1></div>
    <div>
        <div style="font-size:.8rem;color:#aaa">TOTAL SCORE</div>
        <div id="total-score" style="font-size:2.5rem;color:var(--accent-color)">0</div>
    </div>
</header>

<div id="scoreboard" class="scoreboard"></div>

<div class="main-content">
    <div class="info-panel">
        <div class="stats-bar">
            <span class="avg-label">AVG (Last 5)</span>
            <span class="avg-value" id="average-score">---</span>
        </div>
        <div id="history-section" style="display:none">
            <ul id="history-list" class="history-list"></ul>
            <button onclick="clearHistory()">履歴を全消去</button>
        </div>
    </div>

    <div class="controls-wrapper">
        <div id="keypad" class="controls">
            <button onclick="addScore(0)">G</button>
            <button onclick="addScore(1)">1</button>
            <button onclick="addScore(2)">2</button>
            <button onclick="addScore(3)">3</button>
            <button onclick="addScore(4)">4</button>
            <button onclick="addScore(5)">5</button>
            <button onclick="addScore(6)">6</button>
            <button onclick="addScore(7)">7</button>
            <button onclick="addScore(8)">8</button>
            <button onclick="addScore(9)">9</button>
            <button onclick="addScore(10)">10</button>
            <button onclick="undo()">↶</button>
            <button onclick="resetGame()">RESET</button>
        </div>
    </div>
</div>

<script>
/* ===== Service Worker ===== */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
    });
}

/* ===== Game Logic ===== */
let rolls=[],currentFrame=1,isFinished=false;
const scoreboard=document.getElementById('scoreboard');
const totalScoreEl=document.getElementById('total-score');
const buttons=document.querySelectorAll('#keypad button');
const STORAGE_KEY='bowlliard_history_v2';

function render(){
    scoreboard.innerHTML='';
    let idx=0,total=0;
    for(let f=1;f<=10;f++){
        const frame=document.createElement('div');
        frame.className='frame'+(f===currentFrame&&!isFinished?' active':'');
        const r1=rolls[idx],r2=rolls[idx+1],r3=rolls[idx+2];
        let score=null;

        if(f<10){
            if(r1===10){score=(r2!=null&&r3!=null)?10+r2+r3:null;idx+=1;}
            else if(r2!=null){
                score=(r1+r2===10)?(r3!=null?10+r3:null):(r1+r2);
                idx+=2;
            }
        }else{
            if(r1!=null&&r2!=null){
                score=(r1===10||r1+r2===10)?(r3!=null?r1+r2+r3:null):(r1+r2);
            }
        }
        if(score!=null){total+=score;}
        frame.innerHTML=`<div>${f}</div><div>${score??''}</div>`;
        scoreboard.appendChild(frame);
    }
    totalScoreEl.textContent=total;
}

function updateFrame(){
    let idx=0,f=1;
    while(f<=10&&idx<rolls.length){
        const r1=rolls[idx];
        if(f<10){
            idx+=r1===10?1:2;
        }else{
            idx+=r1===10||rolls[idx]+rolls[idx+1]===10?3:2;
        }
        f++;
    }
    currentFrame=f;
}

function addScore(p){
    if(isFinished)return;
    rolls.push(p);
    updateFrame();
    render();
    if(currentFrame>10){
        isFinished=true;
        saveHistory(Number(totalScoreEl.textContent));
    }
}

function undo(){
    if(rolls.length){
        rolls.pop();
        isFinished=false;
        updateFrame();
        render();
    }
}

function resetGame(){
    if(confirm('リセットしますか？')){
        rolls=[];currentFrame=1;isFinished=false;
        render();
    }
}

function getHistory(){
    return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
}
function saveHistory(score){
    const h=getHistory();
    h.unshift({score,date:new Date().toLocaleString()});
    localStorage.setItem(STORAGE_KEY,JSON.stringify(h.slice(0,50)));
}
function clearHistory(){
    if(confirm('削除しますか？')){
        localStorage.removeItem(STORAGE_KEY);
    }
}

render();
</script>
</body>
</html>
